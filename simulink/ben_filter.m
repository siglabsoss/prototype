% function [data] = ben_filter()


%   The rf front end will mix the center of the 915Mhz spectrum to 40Mhz
%   The ADC will then read this directly
%   902Mhz is 27Mhz
%   915Mhz is 40Mhz
%   928Mhz is 53Mhz

    pre_adc_shift = -875E6;


    fs = 250E6;
    time = 0.01;
    samples = round(fs*time);
    
    
    center = 915E6;
    
    f1 = 916E6+25E3;
    f2 = 916E6+134E3;
    f3 = 916E6+76E3;
    
    % used for matlab functions that output a max val of 1.0
    float_scale = 32768;
%     float_scale = 1;
    
    % make our input data: pure sin waves (float)
    t1 = real( tone_gen( samples, fs, f1 + pre_adc_shift) ) * 0.5;
    t2 = real( tone_gen( samples, fs, f2 + pre_adc_shift) ) * 0.5;    

    %snr if applied
    snr = -30;
    
    % at this point data is real only as received from the ADC, with 16 bit ints
    data = int16(round(awgn(t1,snr) * float_scale + awgn(t2,snr) * float_scale));
%     data = int16(round(t1 * float_scale + t2 * float_scale));
    
    % convert to complex but set Q to all 0
    data = complex(data,0);
    
    % shift the center to 0, so 915 is at 0, 902 is at -13, 928 is at 13
    shift = int16(tone_gen(samples, fs, -1 * (center + pre_adc_shift) ) * float_scale);
    data_shifted = complex_mult16(data,shift);
    
    
    % filter our region of interest
    coefficients = [-0.000095930605388913124 ;-0.0001148838710616709   ;-0.00017499811369544081  ;-0.0002469097713526833   ;-0.00032802130892174811  ;-0.00041383588764852297  ;-0.00049787892449699371  ;-0.00057246070519665466  ;-0.00062833306120143543  ;-0.00065579477233564359  ;-0.00064498803096952164  ;-0.00058696676335441371  ;-0.00047462531620344229  ;-0.00030336634935875791  ;-0.000072133074136506513 ; 0.00021628661072394076  ; 0.00055457869595812817  ; 0.0009311435321748484   ; 0.0013302599838439491   ; 0.0017329618507732666   ; 0.0021179926549249111   ; 0.0024631976584751172   ; 0.0027470272397693242   ; 0.0029502603432789579   ; 0.0030575376427353978   ; 0.003058875437539208    ; 0.0029505940996230034   ; 0.0027361240449571937   ; 0.0024259569705770948   ; 0.0020373945628237612   ; 0.001593358545171611    ; 0.0011210250703962308   ; 0.00064974555036055701  ; 0.00020898600565079535  ;-0.00017405807402072094  ;-0.00047652032281146769  ;-0.00068182893279691685  ;-0.00078098104955006916  ;-0.00077343571731545448  ;-0.00066706301686726471  ;-0.00047764321496261583  ;-0.00022738013405935423  ; 0.000056870509391421252 ; 0.00034610333424198002  ; 0.00061157354330828196  ; 0.00082747784493927324  ; 0.00097312049724671706  ; 0.0010348777664781652   ; 0.0010072873670208438   ; 0.00089360540605373903  ; 0.00070531991607350778  ; 0.00046111190024193389  ; 0.00018489315783425347  ;-0.000096412221770766923 ;-0.00035564069282286478  ;-0.00056792166472177858  ;-0.00071325867920752034  ;-0.00077836615591650535  ;-0.00075810984917271064  ;-0.00065588839346613585  ;-0.00048340219566057863  ;-0.00025935154119784159  ;-0.0000076447114167876862; 0.00024514868462654523  ; 0.00047240337655073301  ; 0.00065028600720345932  ; 0.00076010011006236709  ; 0.00079035105697983601  ; 0.00073783254403789807  ; 0.00060810348488343671  ; 0.00041481068410186852  ; 0.00017840725545304809  ;-0.000076084907273022957 ;-0.00032158091893974685  ;-0.00053189656803988891  ;-0.00068442633193796509  ;-0.00076267358079473019  ;-0.00075794553948491908  ;-0.00067044263506891352  ;-0.00050919765684711736  ;-0.00029128713357699131  ;-0.000039955530085913077 ; 0.00021771612571524809  ; 0.00045379823065274896  ; 0.00064240379132599339  ; 0.00076260997525469387  ; 0.00080066874211660855  ; 0.00075167290006502088  ; 0.00062008645892267975  ; 0.00041946124188100848  ; 0.00017097436189498762  ;-0.000098688112417745754 ;-0.00036026563239581835  ;-0.00058498269909730159  ;-0.0007477934925413281   ;-0.00083006595674276786  ;-0.00082180234554534532  ;-0.00072275187299454373  ;-0.00054266932537354556  ;-0.0003002933975505028   ;-0.000021511988627432805 ; 0.00026346229143552193  ; 0.00052325695738602901  ; 0.00072885322875043397  ; 0.00085672627654214306  ; 0.00089160380630237332  ; 0.00082819051966516108  ; 0.00067199597519023249  ; 0.00043881341383384483  ; 0.00015323304294570479  ;-0.00015401085275100639  ;-0.00044924332320464707  ;-0.0006995989119572628   ;-0.00087658314958601242  ;-0.00095937201531383939  ;-0.00093716688117950102  ;-0.0008106363925182295   ;-0.00059196881449126817  ;-0.00030380213950102037  ; 0.000023167877264578679 ; 0.00035336437733847492  ; 0.00065025278208721946  ; 0.00088029236601268627  ; 0.0010167786769594007   ; 0.0010428535927289938   ; 0.00095362566361577067  ; 0.00075686348782301059  ; 0.00047243739638346677  ; 0.00013027757167744685  ;-0.00023268976501619293  ;-0.00057656702132269735  ;-0.00086279031035703206  ;-0.0010584948433299212   ;-0.0011402069633357458   ;-0.0010966909603884688   ;-0.0009303684105557773   ;-0.00065737515790063384  ;-0.00030597492009773697  ; 0.000086282416752579005 ; 0.0004766068328521512   ; 0.00082155999200804962  ; 0.0010819210255341035   ; 0.0012270721825659984   ; 0.001238622567656019    ; 0.0011126424398527472   ; 0.00086043852889105849  ; 0.00050754996710531504  ; 0.000091245049132931378 ;-0.00034343707224090866  ;-0.00074848679544758142  ;-0.0010782520722536194   ;-0.0012945139321415312   ;-0.0013709345224323832   ;-0.001296181107395494    ;-0.0010755357167909062   ;-0.00073060340061189676  ;-0.00029728447707900253  ; 0.00017796736942755464  ; 0.00064305673883366268  ; 0.0010459676982399644   ; 0.001340514576696056    ; 0.0014916432057597508   ; 0.0014795249948117782   ; 0.0013021206739156597   ; 0.0009757410767495553   ; 0.00053365251829906623  ; 0.000022693281881350978 ;-0.00050162156694771312  ;-0.00098113206768543127  ;-0.0013614228531732189   ;-0.0015979946415042895   ;-0.0016614015749926892   ;-0.0015408822281846744   ;-0.0012459280202295059   ;-0.00080568980451610375  ;-0.00026612400669708957  ; 0.00031473584346942193  ; 0.00087301205418481771  ; 0.0013459460923670873   ; 0.0016789422773132961   ; 0.0018318042278546963   ; 0.0017835529851145907   ; 0.0015351632039445912   ; 0.0011099590549508713   ; 0.00055148567642423119  ;-0.00008087630624106765  ;-0.0007181989567241505   ;-0.0012894570103189474   ;-0.0017294186145078308   ;-0.0019860268585086471   ;-0.0020265187333390771   ;-0.0018414935819948285   ;-0.0014465073035419141   ;-0.00088088696805028554  ;-0.00020390305909336661  ; 0.00051139913718998957  ; 0.0011860149879827048   ; 0.0017436675940688819   ; 0.0021193638824387245   ; 0.0022669171424931777   ; 0.0021645224936594834   ; 0.0018177708158860404   ; 0.0012596551594696694   ; 0.00054754822717277226  ;-0.00024263209530886782  ;-0.0010244394639613212   ;-0.0017103009808720707   ;-0.0022212497926897487   ;-0.0024959501659556696   ;-0.0024979587517021361   ;-0.00222040249442821     ;-0.001687460650430584    ;-0.00095243607575545256  ;-0.000092520585737147521 ; 0.00079921828303993272  ; 0.0016238314904609588   ; 0.0022873754363411493   ; 0.0027115260633707281   ; 0.0028427091319895154   ; 0.00265871403191677     ; 0.0021719729765883604   ; 0.0014290716015645758   ; 0.00050643541851566924  ;-0.00049741562351189714  ;-0.001472280771289006    ;-0.0023082638393837418   ;-0.0029080452870055978   ;-0.0031980773993384639   ;-0.0031374349389053056   ;-0.0027232682992138438   ;-0.001992166660321015    ;-0.0010171641079685847   ; 0.00009939412268429758  ; 0.0012364480542913436   ; 0.0022672008142594945   ; 0.0030731001164527854   ; 0.0035573023448979275   ; 0.0036561031973735133   ; 0.0033470141950483956   ; 0.0026524842821950894   ; 0.0016387345616712462   ; 0.00040968453482075355  ;-0.00090349364015151839  ;-0.002156171870679572    ;-0.0032059761273449464   ;-0.0039287343061548269   ;-0.0042328914048203213   ;-0.0040707580539825119   ;-0.003445234507950058    ;-0.0024111366109727124   ;-0.0010707899172282486   ; 0.00043578867079814343  ; 0.0019452275397482499   ; 0.0032882014895886779   ; 0.0043080910486544026   ; 0.0048788638954069888   ; 0.004920191817059983    ; 0.0044080236064846148   ; 0.0033793049836799475   ; 0.0019301030849637861   ; 0.00020712471408298853  ;-0.0016066931159683458   ;-0.003311130939409321    ;-0.004710275277617147    ;-0.0056344525380756152   ;-0.0059601319087420057   ;-0.0056255140180650753   ;-0.0046399469560220261   ;-0.0030858746592762202   ;-0.0011128235449440315   ; 0.0010762568971257932   ; 0.0032451050459655056   ; 0.0051488040363537393   ; 0.0065604729771051307   ; 0.0072971953849926873   ; 0.0072423148885839162   ; 0.0063615381077394405   ; 0.0047108004662925369   ; 0.0024346857026038334   ;-0.00024489269383320262  ;-0.0030489750715976113   ;-0.005669079701494736    ;-0.0077993601218571467   ;-0.0091702125230129581   ;-0.009579815235833582    ;-0.0089201660007885882   ;-0.007194561512550237    ;-0.0045242400775348862   ;-0.0011428870343736554   ; 0.0026210765001474664   ; 0.0063732866458730674   ; 0.0096909589531617851   ; 0.012165820974872382    ; 0.013448399957994728    ; 0.0132893087741796      ; 0.011573236233103069    ; 0.0083418909666897884   ; 0.0038030321597998808   ;-0.0016760338201619374   ;-0.0075907062108729103   ;-0.013335784248810396    ;-0.018253887195724905    ;-0.021691642555421421    ;-0.02305882192379902     ;-0.021885126266257861    ;-0.017869368997249044    ;-0.010916306511822578    ;-0.0011573573651295086   ; 0.011047213700340692    ; 0.025125453824221124    ; 0.040329324966981946    ; 0.055786177826362991    ; 0.070562067025182224    ; 0.083731747037634585    ; 0.094449523043003053    ; 0.10201496721019758     ; 0.10592789781664971     ; 0.10592789781664971     ; 0.10201496721019758     ; 0.094449523043003053    ; 0.083731747037634585    ; 0.070562067025182224    ; 0.055786177826362991    ; 0.040329324966981946    ; 0.025125453824221124    ; 0.011047213700340692    ;-0.0011573573651295086   ;-0.010916306511822578    ;-0.017869368997249044    ;-0.021885126266257861    ;-0.02305882192379902     ;-0.021691642555421421    ;-0.018253887195724905    ;-0.013335784248810396    ;-0.0075907062108729103   ;-0.0016760338201619374   ; 0.0038030321597998808   ; 0.0083418909666897884   ; 0.011573236233103069    ; 0.0132893087741796      ; 0.013448399957994728    ; 0.012165820974872382    ; 0.0096909589531617851   ; 0.0063732866458730674   ; 0.0026210765001474664   ;-0.0011428870343736554   ;-0.0045242400775348862   ;-0.007194561512550237    ;-0.0089201660007885882   ;-0.009579815235833582    ;-0.0091702125230129581   ;-0.0077993601218571467   ;-0.005669079701494736    ;-0.0030489750715976113   ;-0.00024489269383320262  ; 0.0024346857026038334   ; 0.0047108004662925369   ; 0.0063615381077394405   ; 0.0072423148885839162   ; 0.0072971953849926873   ; 0.0065604729771051307   ; 0.0051488040363537393   ; 0.0032451050459655056   ; 0.0010762568971257932   ;-0.0011128235449440315   ;-0.0030858746592762202   ;-0.0046399469560220261   ;-0.0056255140180650753   ;-0.0059601319087420057   ;-0.0056344525380756152   ;-0.004710275277617147    ;-0.003311130939409321    ;-0.0016066931159683458   ; 0.00020712471408298853  ; 0.0019301030849637861   ; 0.0033793049836799475   ; 0.0044080236064846148   ; 0.004920191817059983    ; 0.0048788638954069888   ; 0.0043080910486544026   ; 0.0032882014895886779   ; 0.0019452275397482499   ; 0.00043578867079814343  ;-0.0010707899172282486   ;-0.0024111366109727124   ;-0.003445234507950058    ;-0.0040707580539825119   ;-0.0042328914048203213   ;-0.0039287343061548269   ;-0.0032059761273449464   ;-0.002156171870679572    ;-0.00090349364015151839  ; 0.00040968453482075355  ; 0.0016387345616712462   ; 0.0026524842821950894   ; 0.0033470141950483956   ; 0.0036561031973735133   ; 0.0035573023448979275   ; 0.0030731001164527854   ; 0.0022672008142594945   ; 0.0012364480542913436   ; 0.00009939412268429758  ;-0.0010171641079685847   ;-0.001992166660321015    ;-0.0027232682992138438   ;-0.0031374349389053056   ;-0.0031980773993384639   ;-0.0029080452870055978   ;-0.0023082638393837418   ;-0.001472280771289006    ;-0.00049741562351189714  ; 0.00050643541851566924  ; 0.0014290716015645758   ; 0.0021719729765883604   ; 0.00265871403191677     ; 0.0028427091319895154   ; 0.0027115260633707281   ; 0.0022873754363411493   ; 0.0016238314904609588   ; 0.00079921828303993272  ;-0.000092520585737147521 ;-0.00095243607575545256  ;-0.001687460650430584    ;-0.00222040249442821     ;-0.0024979587517021361   ;-0.0024959501659556696   ;-0.0022212497926897487   ;-0.0017103009808720707   ;-0.0010244394639613212   ;-0.00024263209530886782  ; 0.00054754822717277226  ; 0.0012596551594696694   ; 0.0018177708158860404   ; 0.0021645224936594834   ; 0.0022669171424931777   ; 0.0021193638824387245   ; 0.0017436675940688819   ; 0.0011860149879827048   ; 0.00051139913718998957  ;-0.00020390305909336661  ;-0.00088088696805028554  ;-0.0014465073035419141   ;-0.0018414935819948285   ;-0.0020265187333390771   ;-0.0019860268585086471   ;-0.0017294186145078308   ;-0.0012894570103189474   ;-0.0007181989567241505   ;-0.00008087630624106765  ; 0.00055148567642423119  ; 0.0011099590549508713   ; 0.0015351632039445912   ; 0.0017835529851145907   ; 0.0018318042278546963   ; 0.0016789422773132961   ; 0.0013459460923670873   ; 0.00087301205418481771  ; 0.00031473584346942193  ;-0.00026612400669708957  ;-0.00080568980451610375  ;-0.0012459280202295059   ;-0.0015408822281846744   ;-0.0016614015749926892   ;-0.0015979946415042895   ;-0.0013614228531732189   ;-0.00098113206768543127  ;-0.00050162156694771312  ; 0.000022693281881350978 ; 0.00053365251829906623  ; 0.0009757410767495553   ; 0.0013021206739156597   ; 0.0014795249948117782   ; 0.0014916432057597508   ; 0.001340514576696056    ; 0.0010459676982399644   ; 0.00064305673883366268  ; 0.00017796736942755464  ;-0.00029728447707900253  ;-0.00073060340061189676  ;-0.0010755357167909062   ;-0.001296181107395494    ;-0.0013709345224323832   ;-0.0012945139321415312   ;-0.0010782520722536194   ;-0.00074848679544758142  ;-0.00034343707224090866  ; 0.000091245049132931378 ; 0.00050754996710531504  ; 0.00086043852889105849  ; 0.0011126424398527472   ; 0.001238622567656019    ; 0.0012270721825659984   ; 0.0010819210255341035   ; 0.00082155999200804962  ; 0.0004766068328521512   ; 0.000086282416752579005 ;-0.00030597492009773697  ;-0.00065737515790063384  ;-0.0009303684105557773   ;-0.0010966909603884688   ;-0.0011402069633357458   ;-0.0010584948433299212   ;-0.00086279031035703206  ;-0.00057656702132269735  ;-0.00023268976501619293  ; 0.00013027757167744685  ; 0.00047243739638346677  ; 0.00075686348782301059  ; 0.00095362566361577067  ; 0.0010428535927289938   ; 0.0010167786769594007   ; 0.00088029236601268627  ; 0.00065025278208721946  ; 0.00035336437733847492  ; 0.000023167877264578679 ;-0.00030380213950102037  ;-0.00059196881449126817  ;-0.0008106363925182295   ;-0.00093716688117950102  ;-0.00095937201531383939  ;-0.00087658314958601242  ;-0.0006995989119572628   ;-0.00044924332320464707  ;-0.00015401085275100639  ; 0.00015323304294570479  ; 0.00043881341383384483  ; 0.00067199597519023249  ; 0.00082819051966516108  ; 0.00089160380630237332  ; 0.00085672627654214306  ; 0.00072885322875043397  ; 0.00052325695738602901  ; 0.00026346229143552193  ;-0.000021511988627432805 ;-0.0003002933975505028   ;-0.00054266932537354556  ;-0.00072275187299454373  ;-0.00082180234554534532  ;-0.00083006595674276786  ;-0.0007477934925413281   ;-0.00058498269909730159  ;-0.00036026563239581835  ;-0.000098688112417745754 ; 0.00017097436189498762  ; 0.00041946124188100848  ; 0.00062008645892267975  ; 0.00075167290006502088  ; 0.00080066874211660855  ; 0.00076260997525469387  ; 0.00064240379132599339  ; 0.00045379823065274896  ; 0.00021771612571524809  ;-0.000039955530085913077 ;-0.00029128713357699131  ;-0.00050919765684711736  ;-0.00067044263506891352  ;-0.00075794553948491908  ;-0.00076267358079473019  ;-0.00068442633193796509  ;-0.00053189656803988891  ;-0.00032158091893974685  ;-0.000076084907273022957 ; 0.00017840725545304809  ; 0.00041481068410186852  ; 0.00060810348488343671  ; 0.00073783254403789807  ; 0.00079035105697983601  ; 0.00076010011006236709  ; 0.00065028600720345932  ; 0.00047240337655073301  ; 0.00024514868462654523  ;-0.0000076447114167876862;-0.00025935154119784159  ;-0.00048340219566057863  ;-0.00065588839346613585  ;-0.00075810984917271064  ;-0.00077836615591650535  ;-0.00071325867920752034  ;-0.00056792166472177858  ;-0.00035564069282286478  ;-0.000096412221770766923 ; 0.00018489315783425347  ; 0.00046111190024193389  ; 0.00070531991607350778  ; 0.00089360540605373903  ; 0.0010072873670208438   ; 0.0010348777664781652   ; 0.00097312049724671706  ; 0.00082747784493927324  ; 0.00061157354330828196  ; 0.00034610333424198002  ; 0.000056870509391421252 ;-0.00022738013405935423  ;-0.00047764321496261583  ;-0.00066706301686726471  ;-0.00077343571731545448  ;-0.00078098104955006916  ;-0.00068182893279691685  ;-0.00047652032281146769  ;-0.00017405807402072094  ; 0.00020898600565079535  ; 0.00064974555036055701  ; 0.0011210250703962308   ; 0.001593358545171611    ; 0.0020373945628237612   ; 0.0024259569705770948   ; 0.0027361240449571937   ; 0.0029505940996230034   ; 0.003058875437539208    ; 0.0030575376427353978   ; 0.0029502603432789579   ; 0.0027470272397693242   ; 0.0024631976584751172   ; 0.0021179926549249111   ; 0.0017329618507732666   ; 0.0013302599838439491   ; 0.0009311435321748484   ; 0.00055457869595812817  ; 0.00021628661072394076  ;-0.000072133074136506513 ;-0.00030336634935875791  ;-0.00047462531620344229  ;-0.00058696676335441371  ;-0.00064498803096952164  ;-0.00065579477233564359  ;-0.00062833306120143543  ;-0.00057246070519665466  ;-0.00049787892449699371  ;-0.00041383588764852297  ;-0.00032802130892174811  ;-0.0002469097713526833   ;-0.00017499811369544081  ;-0.0001148838710616709   ;-0.000095930605388913124 ];
    
    %view this filter with
%     fvtool(coefficients);
    
    % scale for int16
    coefficients = int16(coefficients*float_scale);
    
    % filter to positive and negative 13 mhz with a rolloff to 14 mhz
    data_filtered = fir_fixed16(data_shifted,coefficients);
    
    
    
    % filter out region of interest
    
    % data = data .* shift;
    
%     data = awgn(data,-40);
    
    
%     datashift = freq_shift(data, fs, -1*(f2-center));
    
%     data = zeros(samples,1);
%     
%     for i = 1:samples
%         tone = (1/fs * 2 * pi * f1) * i;
%         data(i) = tone;
%     end
    
%     return data;
    
% end